---
import ImageWrapper from "../components/misc/ImageWrapper.astro";
import { sidebarLayoutConfig, siteConfig } from "../config";
import localGameList from "../data/game";
import I18nKey from "../i18n/i18nKey";
import { i18n } from "../i18n/translation";
import MainGridLayout from "../layouts/MainGridLayout.astro";
import fs from "node:fs";
import path from "node:path";
import "../styles/game.css";

interface GameItem {
    title: string;
    cover: string;
    link: string;
    status: string;
    rating: number;
    progress: number;
    totalProgress: number;
    description: string;
    year: string;
    developer: string;
    genre: string[];
    platform: string;
}

if (!siteConfig.featurePages.game) {
    return Astro.redirect("/404/");
}

const isBothSidebarMode = sidebarLayoutConfig.position === "both";
const BANGUMI_USER_ID = siteConfig.bangumi?.userId || "your-user-id";
const GAME_MODE = siteConfig.game?.mode || "bangumi";

let gameList: GameItem[] = [];

if (GAME_MODE === "local") {
    gameList = localGameList;
} else {
    const isDev = import.meta.env.DEV;
    const shouldFetchOnDev = siteConfig.bangumi?.fetchOnDev ?? false;
    const skipLoad = isDev && !shouldFetchOnDev;

    if (skipLoad) {
        console.log("[Dev] Skipping Bangumi game data load (fetchOnDev is off).");
        gameList = [];
    } else {
        try {
            const dataPath = path.join(process.cwd(), "src/data/bangumi-game-data.json");
            if (fs.existsSync(dataPath)) {
                const fileContent = fs.readFileSync(dataPath, "utf-8");
                const rawData = JSON.parse(fileContent);
                gameList = rawData.map((item: any) => ({
                    title: item.title || "Unknown",
                    cover: item.cover || "",
                    link: item.link || "",
                    status: item.status || "planned",
                    rating: Number(item.rating) || 0,
                    progress: Number(item.progress) || 0,
                    totalProgress: Number(item.totalProgress) || 0,
                    description: item.description || "",
                    year: item.year || "",
                    developer: item.developer || "",
                    genre: Array.isArray(item.genre) ? item.genre : [],
                    platform: item.platform || "",
                }));
            } else {
                console.warn(`Bangumi game data file not found at ${dataPath}.`);
                gameList = [];
            }
        } catch (error) {
            console.error("Failed to load game data:", error);
            gameList = [];
        }
    }
}

function getStatusInfo(status: string) {
    switch (status) {
        case "playing":
            return {
                text: i18n(I18nKey.gameStatusPlaying),
                class: "bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300",
                icon: "üéÆ",
            };
        case "completed":
            return {
                text: i18n(I18nKey.gameStatusCompleted),
                class: "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300",
                icon: "‚úì",
            };
        case "planned":
            return {
                text: i18n(I18nKey.gameStatusPlanned),
                class: "bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-300",
                icon: "‚ù§",
            };
        case "onhold":
            return {
                text: i18n(I18nKey.gameStatusOnHold),
                class: "bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300",
                icon: "‚è∏",
            };
        case "dropped":
            return {
                text: i18n(I18nKey.gameStatusDropped),
                class: "bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300",
                icon: "‚úó",
            };
        default:
            return {
                text: status,
                class: "bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300",
                icon: "?",
            };
    }
}

const INITIAL_DISPLAY_COUNT = 24;
const visibleGameList = gameList.slice(0, INITIAL_DISPLAY_COUNT);
const hiddenGameList = gameList.slice(INITIAL_DISPLAY_COUNT);
---

<MainGridLayout
    title={i18n(I18nKey.game)}
    description={i18n(I18nKey.gameSubtitle)}
>
    <div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
        <div class="card-base game-card-base z-10 px-9 py-6 relative w-full">
            <div class="relative w-full mb-8">
                <div class="mb-6">
                    <h1
                        class="text-4xl font-bold text-black/90 dark:text-white/90 mb-2 relative
                    before:w-1 before:h-8 before:rounded-md before:bg-[var(--primary)]
                    before:absolute before:top-1/2 before:-translate-y-1/2 before:-left-4"
                    >
                        {i18n(I18nKey.gameTitle)}
                    </h1>
                    <p class="text-black/75 dark:text-white/75">{i18n(I18nKey.gameSubtitle)}</p>
                </div>

                <div class="mb-6">
                    <div class="game-filter-container flex flex-wrap gap-2">
                        <button class="game-filter-tag game-active" data-status="all">{i18n(I18nKey.gameFilterAll)}</button>
                        <button class="game-filter-tag" data-status="playing">{i18n(I18nKey.gameStatusPlaying)}</button>
                        <button class="game-filter-tag" data-status="planned">{i18n(I18nKey.gameStatusPlanned)}</button>
                        <button class="game-filter-tag" data-status="completed">{i18n(I18nKey.gameStatusCompleted)}</button>
                        {
                            GAME_MODE === "bangumi" && (
                                <>
                                    <button class="game-filter-tag" data-status="onhold">{i18n(I18nKey.gameStatusOnHold)}</button>
                                    <button class="game-filter-tag" data-status="dropped">{i18n(I18nKey.gameStatusDropped)}</button>
                                </>
                            )
                        }
                    </div>
                </div>
            </div>

            <div class="mb-8">
                {
                    GAME_MODE !== "local" && BANGUMI_USER_ID === "your-user-id" ? (
                        <div class="text-center py-12">
                            <div class="text-5xl mb-4">üò¢</div>
                            <h3 class="text-xl font-medium text-black/80 dark:text-white/80 mb-2">
                                {i18n(I18nKey.gameEmpty)}
                            </h3>
                            <p class="text-black/60 dark:text-white/60">
                                Please set your Bangumi userId in the
                                src/config.ts file
                            </p>
                        </div>
                    ) : visibleGameList.length > 0 ? (
                        <>
                            <div
                                id="game-list-container"
                                class={`game-grid-container grid gap-4 md:gap-6 opacity-0 transition-opacity duration-300`}
                            >
                                {visibleGameList.map((game) => {
                                    const statusInfo = getStatusInfo(game.status);
                                    const progressPercent =
                                        game.totalProgress > 0
                                            ? (game.progress / game.totalProgress) * 100
                                            : 0;

                                    return (
                                        <div
                                            class="group relative bg-[var(--card-bg)] border border-[var(--line-divider)] rounded-[var(--radius-large)] overflow-hidden hover:shadow-lg"
                                            data-game-status={game.status}
                                        >
                                            <div class="relative game-cover-container aspect-[2/3] overflow-hidden">
                                                <a
                                                    href={game.link}
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                    class="block w-full h-full"
                                                >
                                                    <ImageWrapper
                                                        src={game.cover}
                                                        alt={game.title}
                                                        class="w-full h-full object-cover transition-transform duration-200 group-hover:scale-110"
                                                    />
                                                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                                        <div class="absolute inset-0 flex items-center justify-center">
                                                            <div class="w-12 h-12 rounded-full bg-white/90 flex items-center justify-center">
                                                                <svg class="w-6 h-6 text-gray-800 ml-1" fill="currentColor" viewBox="0 0 24 24">
                                                                    <path d="M8 5v14l11-7z" />
                                                                </svg>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </a>

                                                <div
                                                    class={`absolute top-2 left-2 px-2 py-1 rounded-md text-xs font-medium ${statusInfo.class}`}
                                                >
                                                    <span class="mr-1">{statusInfo.icon}</span>
                                                    <span>{statusInfo.text}</span>
                                                </div>

                                                <div class="absolute top-2 right-2 bg-black/70 text-white px-2 py-1 rounded-md text-xs font-medium flex items-center gap-1">
                                                    <svg
                                                        class="w-3 h-3 text-yellow-400"
                                                        fill="currentColor"
                                                        viewBox="0 0 20 20"
                                                    >
                                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                                    </svg>
                                                    <span>{game.rating}</span>
                                                </div>

                                                {game.status === "playing" && (
                                                    <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-2">
                                                        <div class="w-full bg-white/20 rounded-full h-1.5 mb-1">
                                                            <div
                                                                class="bg-gradient-to-r from-emerald-400 to-teal-400 h-1.5 rounded-full transition-all duration-300"
                                                                style={`width: ${progressPercent}%`}
                                                            />
                                                        </div>
                                                        <div class="text-white text-xs font-medium">
                                                            {game.progress}/{game.totalProgress} (
                                                            {Math.round(progressPercent)}
                                                            %)
                                                        </div>
                                                    </div>
                                                )}
                                            </div>

                                            <div class="p-3">
                                                <h3 class="text-sm font-bold text-black/90 dark:text-white/90 mb-1 leading-tight">
                                                    {game.title}
                                                </h3>
                                                <p
                                                    class="text-black/60 dark:text-white/60 text-xs mb-2 line-clamp-2"
                                                    title={game.description}
                                                >
                                                    {game.description}
                                                </p>

                                                <div class="space-y-1 text-xs">
                                                    <div class="flex justify-between items-center">
                                                        <span class="text-black/50 dark:text-white/50 shrink-0">
                                                            {i18n(I18nKey.gameYear)}
                                                        </span>
                                                        <span class="text-black/70 dark:text-white/70 truncate ml-2 text-right">
                                                            {game.year}
                                                        </span>
                                                    </div>
                                                    <div class="flex justify-between items-start">
                                                        <span class="text-black/50 dark:text-white/50 shrink-0 mt-0.5">
                                                            {i18n(I18nKey.gameDeveloper)}
                                                        </span>
                                                        <span
                                                            class="text-black/70 dark:text-white/70 text-right ml-2 line-clamp-2 break-words"
                                                            title={game.developer}
                                                        >
                                                            {game.developer}
                                                        </span>
                                                    </div>
                                                    <div class="flex flex-wrap gap-1 mt-2">
                                                        {game.genre.map((g) => (
                                                            <span class="px-1.5 py-0.5 bg-[var(--btn-regular-bg)] text-black/70 dark:text-white/70 rounded text-xs">
                                                                {g}
                                                            </span>
                                                        ))}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>

                            <template id="game-lazy-store">
                                {hiddenGameList.map((game) => {
                                    const statusInfo = getStatusInfo(game.status);
                                    const progressPercent =
                                        game.totalProgress > 0
                                            ? (game.progress / game.totalProgress) * 100
                                            : 0;

                                    return (
                                        <div
                                            class="group relative bg-[var(--card-bg)] border border-[var(--line-divider)] rounded-[var(--radius-large)] overflow-hidden hover:shadow-lg"
                                            data-game-status={game.status}
                                        >
                                            <div class="relative game-cover-container aspect-[2/3] overflow-hidden">
                                                <a
                                                    href={game.link}
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                    class="block w-full h-full"
                                                >
                                                    <ImageWrapper
                                                        src={game.cover}
                                                        alt={game.title}
                                                        class="w-full h-full object-cover transition-transform duration-200 group-hover:scale-110"
                                                    />
                                                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                                        <div class="absolute inset-0 flex items-center justify-center">
                                                            <div class="w-12 h-12 rounded-full bg-white/90 flex items-center justify-center">
                                                                <svg class="w-6 h-6 text-gray-800 ml-1" fill="currentColor" viewBox="0 0 24 24">
                                                                    <path d="M8 5v14l11-7z" />
                                                                </svg>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </a>

                                                <div
                                                    class={`absolute top-2 left-2 px-2 py-1 rounded-md text-xs font-medium ${statusInfo.class}`}
                                                >
                                                    <span class="mr-1">{statusInfo.icon}</span>
                                                    <span>{statusInfo.text}</span>
                                                </div>

                                                <div class="absolute top-2 right-2 bg-black/70 text-white px-2 py-1 rounded-md text-xs font-medium flex items-center gap-1">
                                                    <svg class="w-3 h-3 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                                                    </svg>
                                                    <span>{game.rating}</span>
                                                </div>

                                                {game.status === "playing" && (
                                                    <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-2">
                                                        <div class="w-full bg-white/20 rounded-full h-1.5 mb-1">
                                                            <div
                                                                class="bg-gradient-to-r from-emerald-400 to-teal-400 h-1.5 rounded-full transition-all duration-300"
                                                                style={`width: ${progressPercent}%`}
                                                            />
                                                        </div>
                                                        <div class="text-white text-xs font-medium">{game.progress}/{game.totalProgress} ({Math.round(progressPercent)}%)</div>
                                                    </div>
                                                )}
                                            </div>

                                            <div class="p-3">
                                                <h3 class="text-sm font-bold text-black/90 dark:text-white/90 mb-1 leading-tight">{game.title}</h3>
                                                <p class="text-black/60 dark:text-white/60 text-xs mb-2 line-clamp-2" title={game.description}>{game.description}</p>

                                                <div class="space-y-1 text-xs">
                                                    <div class="flex justify-between items-center">
                                                        <span class="text-black/50 dark:text-white/50 shrink-0">{i18n(I18nKey.gameYear)}</span>
                                                        <span class="text-black/70 dark:text-white/70 truncate ml-2 text-right">{game.year}</span>
                                                    </div>
                                                    <div class="flex justify-between items-start">
                                                        <span class="text-black/50 dark:text-white/50 shrink-0 mt-0.5">{i18n(I18nKey.gameDeveloper)}</span>
                                                        <span class="text-black/70 dark:text-white/70 text-right ml-2 line-clamp-2 break-words" title={game.developer}>{game.developer}</span>
                                                    </div>
                                                    <div class="flex flex-wrap gap-1 mt-2">
                                                        {game.genre.map((g) => (<span class="px-1.5 py-0.5 bg-[var(--btn-regular-bg)] text-black/70 dark:text-white/70 rounded text-xs">{g}</span>))}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </template>

                            {hiddenGameList.length > 0 && (
                                <div
                                    id="infinite-scroll-sentinel-game"
                                    class="w-full h-20 flex items-center justify-center mt-8"
                                >
                                    <div class="game-loading-spinner w-8 h-8 border-4 border-[var(--primary)] border-t-transparent rounded-full animate-spin" />
                                </div>
                            )}
                        </>
                    ) : (
                        <div class="text-center py-12">
                            <div class="text-5xl mb-4">üò¢</div>
                            <h3 class="text-xl font-medium text-black/80 dark:text-white/80 mb-2">
                                {i18n(I18nKey.gameEmpty)}
                            </h3>
                            <p class="text-black/60 dark:text-white/60">
                                {GAME_MODE === "local"
                                    ? i18n(I18nKey.gameEmptyLocal)
                                    : i18n(I18nKey.gameEmptyBangumi)}
                            </p>
                        </div>
                    )
                }
            </div>
        </div>
    </div>

    <script is:inline define:vars={{ isBothSidebarMode }}>
        (function () {
            function initGameLayout() {
                const gameListContainer = document.getElementById(
                    "game-list-container",
                );
                if (!gameListContainer) return false;
                const currentLayout =
                    localStorage.getItem("postListLayout") || "list";
                updateGameListLayout(currentLayout, false);
                requestAnimationFrame(() => {
                    gameListContainer.classList.remove("opacity-0");
                });
                return true;
            }

            let retryCount = 0;
            const maxRetries = 10;
            function tryInit() {
                if (initGameLayout()) return;
                if (retryCount < maxRetries) {
                    retryCount++;
                    const delay = Math.min(
                        100 * Math.pow(1.5, retryCount),
                        1000,
                    );
                    setTimeout(tryInit, delay);
                } else {
                    setTimeout(() => {
                        const gameListContainer = document.getElementById(
                            "game-list-container",
                        );
                        if (gameListContainer) {
                            const currentLayout =
                                localStorage.getItem("postListLayout") ||
                                "list";
                            updateGameListLayout(currentLayout, false);
                            gameListContainer.classList.remove("opacity-0");
                        }
                    }, 2000);
                }
            }

            if (document.readyState === "loading") {
                document.addEventListener("DOMContentLoaded", tryInit);
            } else {
                tryInit();
            }

            function updateGameListLayout(layout, shouldAnimate = true) {
                const gameListContainer = document.getElementById(
                    "game-list-container",
                );
                if (!gameListContainer) return;
                gameListContainer.dataset.currentLayout = layout;

                const gameItems = Array.from(
                    document.querySelectorAll("[data-game-status]"),
                );
                const visibleItems = gameItems.filter(
                    (item) => item.offsetParent !== null,
                );
                const firstPositions = new Map();
                if (shouldAnimate) {
                    visibleItems.forEach((item) => {
                        const rect = item.getBoundingClientRect();
                        firstPositions.set(item, {
                            left: rect.left,
                            top: rect.top,
                            width: rect.width,
                            height: rect.height,
                        });
                    });
                }

                const style = document.createElement("style");
                style.innerHTML = `.game-grid-container .group { transition: none !important; }`;
                document.head.appendChild(style);
                gameListContainer.classList.remove(
                    "game-list-mode",
                    "game-grid-mode",
                );
                gameListContainer.classList.remove(
                    "grid-cols-1",
                    "md:grid-cols-2",
                    "lg:grid-cols-3",
                );

                if (layout === "grid") {
                    gameListContainer.classList.add("game-grid-mode");
                    const rightSidebar = document.querySelector(
                        ".right-sidebar-container",
                    );
                    if (rightSidebar) {
                        rightSidebar.style.display = "none";
                        rightSidebar.classList.add("hidden-in-grid-mode");
                    }
                    const mainGrid = document.getElementById("main-grid");
                    if (mainGrid) {
                        mainGrid.style.gridTemplateColumns = "17.5rem 1fr";
                        mainGrid.classList.add("two-column-layout");
                    }
                } else {
                    gameListContainer.classList.add("game-list-mode");
                    gameListContainer.classList.add(
                        "grid-cols-1",
                        "lg:grid-cols-2",
                    );
                    const rightSidebar = document.querySelector(
                        ".right-sidebar-container",
                    );
                    if (rightSidebar) {
                        rightSidebar.style.display = "";
                        rightSidebar.classList.remove("hidden-in-grid-mode");
                    }
                    const mainGrid = document.getElementById("main-grid");
                    if (mainGrid) {
                        mainGrid.style.gridTemplateColumns = "";
                        mainGrid.classList.remove("two-column-layout");
                    }
                }

                void gameListContainer.offsetHeight;
                if (!shouldAnimate) {
                    if (style.parentNode) style.parentNode.removeChild(style);
                    return;
                }

                requestAnimationFrame(() => {
                    if (style.parentNode) style.parentNode.removeChild(style);

                    visibleItems.forEach((item) => {
                        const first = firstPositions.get(item);
                        if (!first) return;
                        const last = item.getBoundingClientRect();

                        const deltaX = Math.round(first.left - last.left);
                        const deltaY = Math.round(first.top - last.top);
                        const deltaW = first.width / last.width;
                        const deltaH = first.height / last.height;

                        if (
                            Math.abs(deltaX) < 1 &&
                            Math.abs(deltaY) < 1 &&
                            Math.abs(deltaW - 1) < 0.01 &&
                            Math.abs(deltaH - 1) < 0.01
                        )
                            return;

                        item.style.willChange = "transform";
                        item.style.transition = "none";
                        item.style.transformOrigin = "top left";
                        item.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(${deltaW}, ${deltaH})`;
                    });

                    void gameListContainer.offsetHeight;
                    requestAnimationFrame(() => {
                        visibleItems.forEach((item) => {
                            item.style.transition =
                                "transform 0.5s cubic-bezier(0.25, 0.8, 0.25, 1)";
                            item.style.transform = "";
                        });
                        setTimeout(() => {
                            visibleItems.forEach((item) => {
                                item.style.transition = "";
                                item.style.transformOrigin = "";
                                item.style.transform = "";
                                item.style.willChange = "";
                            });
                        }, 500);
                    });
                });
            }

            window.addEventListener("layoutChange", (event) => {
                updateGameListLayout(event.detail.layout);
            });
        })();
    </script>

    <script is:inline>
        if (typeof window.gameFilterEventListeners === "undefined") {
            window.gameFilterEventListeners = [];
        }

        function initGameFilterButtons() {
            const filterTags = document.querySelectorAll(".game-filter-tag");
            const sentinel = document.getElementById(
                "infinite-scroll-sentinel-game",
            );
            const listContainer = document.getElementById(
                "game-list-container",
            );
            const lazyStore = document.getElementById("game-lazy-store");
            window.gameFilterEventListeners.forEach((listener) => {
                const [element, type, handler] = listener;
                element.removeEventListener(type, handler);
            });
            window.gameFilterEventListeners = [];

            filterTags.forEach((tag) => {
                const clickHandler = function () {
                    if (this.classList.contains("game-active")) return;

                    filterTags.forEach((t) => t.classList.remove("game-active"));
                    this.classList.add("game-active");

                    if (
                        lazyStore &&
                        lazyStore.content.children.length > 0 &&
                        listContainer
                    ) {
                        const fragment = document.createDocumentFragment();
                        while (lazyStore.content.firstChild) {
                            const node = lazyStore.content.firstChild;
                            fragment.appendChild(node);
                        }
                        listContainer.appendChild(fragment);
                    }

                    if (sentinel) sentinel.style.display = "none";
                    const initialHidden =
                        listContainer.querySelectorAll(".initial-hidden");
                    initialHidden.forEach((el) => {
                        el.classList.remove("hidden", "initial-hidden");
                    });

                    const status = this.getAttribute("data-status");
                    const gameItems = Array.from(listContainer.children).filter(
                        (item) => item.hasAttribute("data-game-status"),
                    );
                    const itemsToHide = [];
                    const itemsToShow = [];
                    const itemsToKeep = [];
                    gameItems.forEach((item) => {
                        const itemStatus = item.getAttribute("data-game-status");
                        const shouldShow = status === "all" || itemStatus === status;
                        const isCurrentlyVisible = !item.classList.contains("game-hidden");

                        if (shouldShow) {
                            isCurrentlyVisible
                                ? itemsToKeep.push(item)
                                : itemsToShow.push(item);
                        } else {
                            if (isCurrentlyVisible) itemsToHide.push(item);
                        }
                    });
                    const firstPositions = new Map();
                    itemsToKeep.forEach((item) => {
                        const rect = item.getBoundingClientRect();
                        firstPositions.set(item, {
                            left: rect.left,
                            top: rect.top,
                        });
                    });
                    const runAnimation = () => {
                        itemsToHide.forEach((item) => {
                            item.classList.add("game-hidden");
                            item.classList.remove("game-fade-out");
                        });
                        itemsToShow.forEach((item) => {
                            item.classList.remove("game-hidden");
                            item.classList.add("game-fade-in");
                            item.style.transition = "none";
                        });
                        itemsToKeep.forEach((item) => {
                            const first = firstPositions.get(item);
                            if (!first) return;

                            const rect = item.getBoundingClientRect();
                            const deltaX = Math.round(first.left - rect.left);
                            const deltaY = Math.round(first.top - rect.top);

                            if (deltaX !== 0 || deltaY !== 0) {
                                item.style.willChange = "transform";
                                item.style.transition = "none";
                                item.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
                            }
                        });
                        requestAnimationFrame(() => {
                            itemsToKeep.forEach((item) => {
                                item.style.transition =
                                    "transform 0.5s cubic-bezier(0.4, 0, 0.2, 1)";
                                item.style.transform = "";
                            });

                            const STAGGER_LIMIT = 20;
                            itemsToShow.forEach((item, index) => {
                                item.style.transition = "";
                                item.style.willChange = "opacity, transform";

                                const delay = index < STAGGER_LIMIT ? index * 30 : 0;
                                item.style.transitionDelay = `${delay}ms`;

                                requestAnimationFrame(() => {
                                    item.classList.remove("game-fade-in");
                                    item.classList.add("game-fade-in-active");
                                });
                            });

                            setTimeout(
                                () => {
                                    [...itemsToKeep, ...itemsToShow].forEach(
                                        (item) => {
                                            item.classList.remove("game-fade-in-active");
                                            item.style.transition = "";
                                            item.style.transform = "";
                                            item.style.opacity = "";
                                            item.style.willChange = "";
                                            item.style.transitionDelay = "";
                                        },
                                    );
                                },
                                600 +
                                    (itemsToShow.length > 0
                                        ? Math.min(itemsToShow.length, 20) * 30
                                        : 0),
                            );
                        });
                    };

                    if (itemsToHide.length > 0) {
                        itemsToHide.forEach((item) => item.classList.add("game-fade-out"));
                        setTimeout(runAnimation, 200);
                    } else {
                        runAnimation();
                    }
                };

                tag.addEventListener("click", clickHandler);
                window.gameFilterEventListeners.push([
                    tag,
                    "click",
                    clickHandler,
                ]);
            });
            if (sentinel && lazyStore && listContainer) {
                const observer = new IntersectionObserver(
                    (entries) => {
                        if (entries[0].isIntersecting) {
                            const BATCH_SIZE = 24;
                            if (lazyStore.content.children.length === 0) {
                                sentinel.style.display = "none";
                                observer.disconnect();
                                return;
                            }

                            const fragment = document.createDocumentFragment();
                            let movedCount = 0;
                            while (
                                lazyStore.content.firstChild &&
                                movedCount < BATCH_SIZE
                            ) {
                                const node = lazyStore.content.firstChild;
                                if (node.nodeType === 1) {
                                    node.classList.add("game-fade-in-active");
                                }
                                fragment.appendChild(node);
                                movedCount++;
                            }

                            requestAnimationFrame(() => {
                                listContainer.appendChild(fragment);
                                if (lazyStore.content.children.length === 0) {
                                    sentinel.style.display = "none";
                                    observer.disconnect();
                                }
                            });
                        }
                    },
                    { rootMargin: "200px" },
                );
                observer.observe(sentinel);
            } else if (sentinel) {
                sentinel.style.display = "none";
            }
        }

        document.addEventListener("DOMContentLoaded", initGameFilterButtons);
        function setupGameSwupListeners() {
            if (window.swup) {
                window.swup.hooks.on("content:replace", () =>
                    setTimeout(initGameFilterButtons, 150),
                );
                window.swup.hooks.on("page:view", () =>
                    setTimeout(initGameFilterButtons, 150),
                );
            }
        }

        if (typeof window !== "undefined") {
            if (window.swup) {
                setupGameSwupListeners();
            } else {
                document.addEventListener("swup:enable", setupGameSwupListeners);
            }
        }
    </script>
</MainGridLayout>
